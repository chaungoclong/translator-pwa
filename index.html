<!doctype html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
    <title>AI Glass Translator</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: #d4fc79;
            background-image: linear-gradient(315deg, #96e6a1 0%, #d4fc79 74%);
            /* Fix height to screen height for app-like feel on all devices */
            height: 100vh;
            color: #1f2937;
            overflow: hidden; /* Prevent body scroll, handle scroll inside elements */
        }

        /* Ambient floating blobs */
        body::before, body::after {
            content: '';
            position: absolute;
            width: 400px;
            height: 400px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            filter: blur(80px);
            z-index: -1;
            animation: floatBlob 20s infinite alternate;
        }
        body::before { top: -100px; left: -100px; }
        body::after { bottom: -100px; right: -100px; animation-delay: -10s; }

        @media (max-width: 768px) {
            body::before, body::after {
                width: 200px;
                height: 200px;
                filter: blur(50px);
            }
        }

        @keyframes floatBlob {
            0% { transform: translate(0, 0); }
            100% { transform: translate(30px, 50px); }
        }

        /* Glassmorphism */
        .glass-panel {
            background: rgba(255, 255, 255, 0.65);
            backdrop-filter: blur(25px) saturate(160%);
            -webkit-backdrop-filter: blur(25px) saturate(160%);
            border: 1px solid rgba(255, 255, 255, 0.4); 
            box-shadow: 0 25px 50px -12px rgba(16, 185, 129, 0.15);
        }

        /* Inputs */
        .glass-input {
            background: rgba(255, 255, 255, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .glass-input:focus-within {
            background: rgba(255, 255, 255, 0.85);
            border-color: rgba(16, 185, 129, 0.3);
            box-shadow: 0 4px 20px rgba(16, 185, 129, 0.1);
        }

        /* Scrollbar - Optimized for textarea */
        textarea {
            scrollbar-width: thin;
            scrollbar-color: rgba(0,0,0,0.1) transparent;
        }
        textarea::-webkit-scrollbar { width: 6px; }
        textarea::-webkit-scrollbar-track { background: transparent; }
        textarea::-webkit-scrollbar-thumb { background-color: rgba(0,0,0,0.1); border-radius: 20px; }
        textarea::-webkit-scrollbar-thumb:hover { background-color: rgba(0,0,0,0.2); }
        textarea:focus { outline: none; }

        /* Spinner */
        .spinner {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: conic-gradient(#0000 10%, #10b981);
            -webkit-mask: radial-gradient(farthest-side,#0000 calc(100% - 3.8px),#000 0);
            mask: radial-gradient(farthest-side,#0000 calc(100% - 3.8px),#000 0);
            animation: spinner-ani 1s infinite linear;
        }
        @keyframes spinner-ani { to { transform: rotate(1turn); } }

        .fade-in-up {
            animation: fadeInUp 0.7s cubic-bezier(0.16, 1, 0.3, 1) forwards;
            opacity: 0;
            transform: translateY(30px);
        }
        @keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }

        /* Custom Select */
        .custom-select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%23374151' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.75rem center;
            background-repeat: no-repeat;
            background-size: 1em 1em;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .action-btn { transition: all 0.2s ease; }
        .action-btn:active { transform: scale(0.92); }
        
        /* Tooltip - Hide on mobile to prevent obstruction */
        .tooltip-container { position: relative; }
        @media (min-width: 768px) {
            .tooltip-container:hover::after {
                content: attr(data-tooltip);
                position: absolute;
                bottom: 115%;
                left: 50%;
                transform: translateX(-50%);
                padding: 6px 10px;
                background: rgba(6, 78, 59, 0.9);
                backdrop-filter: blur(4px);
                color: white;
                font-size: 11px;
                font-weight: 600;
                border-radius: 8px;
                white-space: nowrap;
                opacity: 0;
                animation: tooltipFade 0.2s forwards;
                pointer-events: none;
                z-index: 20;
            }
        }
        @keyframes tooltipFade {
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
            from { opacity: 0; transform: translateX(-50%) translateY(5px); }
        }
    </style>
</head>
<body class="flex items-center justify-center p-0 md:p-4 h-screen w-screen overflow-hidden relative bg-fixed">

    <!-- 
        Mobile: h-full (100% height)
        PC/Tablet: h-[92vh] (92% height) -> Fills most of the screen vertically
    -->
    <div class="glass-panel w-full max-w-7xl h-full md:h-[92vh] rounded-none md:rounded-[2rem] overflow-hidden flex flex-col shadow-none md:shadow-2xl relative transition-all duration-300 fade-in-up">
        
        <!-- Loading Overlay -->
        <div id="uiLoadingOverlay" class="absolute inset-0 z-50 bg-white/60 backdrop-blur-md flex items-center justify-center hidden">
            <div class="flex flex-col items-center gap-3">
                <div class="spinner"></div>
                <p class="text-green-600 font-semibold text-sm">Loading...</p>
            </div>
        </div>

        <!-- HEADER AREA -->
        <div class="border-b border-white/30 p-3 sm:p-4 md:px-8 md:py-5 flex flex-col gap-3 md:gap-4 bg-white/10 shrink-0 z-20">
            
            <!-- Top Row: Logo & UI Language -->
            <div class="flex items-center justify-between gap-2">
                <!-- Logo -->
                <div class="flex items-center gap-2 md:gap-3 group cursor-default">
                    <div class="w-8 h-8 md:w-12 md:h-12 rounded-lg md:rounded-2xl bg-gradient-to-br from-green-400 to-emerald-600 flex items-center justify-center text-white font-bold text-lg md:text-2xl shadow-lg shadow-green-500/20 group-hover:rotate-6 transition-transform duration-500 ease-out shrink-0">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="md:w-6 md:h-6"><path d="m5 8 6 6"/><path d="m4 14 6-6 2-3"/><path d="M2 5h12"/><path d="M7 2h1"/><path d="m22 22-5-10-5 10"/><path d="M14 18h6"/></svg>
                    </div>
                    <div>
                        <h1 class="text-sm md:text-xl font-bold text-gray-800 leading-tight tracking-tight drop-shadow-sm">Translator <span class="text-emerald-600">Pro</span></h1>
                        <p class="text-[8px] md:text-xs text-gray-500 font-bold tracking-wider uppercase opacity-70 hidden sm:block">AI Powered</p>
                    </div>
                </div>

                <!-- UI Language Switcher -->
                <div class="flex items-center gap-1 bg-white/30 rounded-lg md:rounded-xl p-1 md:p-1.5 hover:bg-white/50 transition-colors backdrop-blur-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" class="ml-1 text-gray-600 md:w-4 md:h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="2" x2="22" y1="12" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
                    <select id="uiLangSelect" class="bg-transparent text-[10px] md:text-xs font-bold text-gray-700 py-1 pr-1 focus:outline-none cursor-pointer border-none ring-0 max-w-[80px] md:max-w-none truncate">
                        <!-- Populated by JS -->
                    </select>
                </div>
            </div>

            <!-- Language Controls Row (Responsive Row on Mobile too) -->
            <div class="flex flex-row items-center gap-2 md:gap-3 relative z-10 w-full">
                <!-- Source Lang -->
                <div class="relative flex-1 group min-w-0">
                    <select id="sourceLang" class="custom-select w-full appearance-none bg-white/40 hover:bg-white/60 backdrop-blur-sm transition-all text-gray-800 text-xs sm:text-sm md:text-base font-bold py-2.5 pl-3 md:py-3 md:pl-5 pr-8 rounded-xl md:rounded-2xl cursor-pointer border-none ring-0 focus:ring-2 focus:ring-green-400/50 shadow-sm truncate">
                    </select>
                </div>

                <!-- Swap Button -->
                <div class="shrink-0 z-20">
                     <button id="swapBtn" class="p-2 md:p-3 rounded-full bg-white/70 text-gray-600 hover:text-emerald-600 hover:bg-white hover:scale-110 transition-all shadow-lg backdrop-blur-sm group tooltip-container border-none" data-tooltip="Đảo ngôn ngữ">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" class="md:w-6 md:h-6 group-hover:rotate-180 transition-transform duration-500 ease-in-out" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 17H4M4 17L8 13M4 17L8 21M4 7H20M20 7L16 3M20 7L16 11"/></svg>
                    </button>
                </div>

                <!-- Target Lang -->
                <div class="relative flex-1 group min-w-0">
                    <select id="targetLang" class="custom-select w-full appearance-none bg-emerald-50/40 hover:bg-emerald-50/70 backdrop-blur-sm transition-all text-emerald-900 text-xs sm:text-sm md:text-base font-bold py-2.5 pl-3 md:py-3 md:pl-5 pr-8 rounded-xl md:rounded-2xl cursor-pointer border-none ring-0 focus:ring-2 focus:ring-emerald-400/50 shadow-sm truncate">
                    </select>
                </div>
            </div>
        </div>

        <!-- MAIN CONTENT AREA -->
        <!-- Use flex-1 to take up all remaining height, and let children fill it -->
        <div class="flex-1 flex flex-col md:flex-row divide-y md:divide-y-0 md:divide-x divide-gray-200/20 min-h-0">
            
            <!-- Source Input Section -->
            <div class="flex flex-col flex-1 relative group glass-input hover:bg-white/60 border-none transition-colors min-h-0">
                <textarea id="source" 
                    placeholder="Nhập văn bản cần dịch..." 
                    class="w-full flex-1 p-4 md:p-8 text-base md:text-xl bg-transparent border-none text-gray-800 resize-none placeholder-gray-500/50 leading-relaxed font-medium focus:ring-0 overflow-auto"></textarea>
                
                <!-- Toolbar Source -->
                <div class="px-3 py-2 md:px-6 md:py-4 flex items-center justify-between transition-all opacity-100 md:opacity-80 md:group-hover:opacity-100 border-t border-white/10 md:border-none shrink-0 bg-white/5 backdrop-blur-[2px]">
                    <div class="text-[9px] md:text-xs font-bold uppercase tracking-wider text-gray-500 bg-black/5 px-2 py-1 rounded-lg backdrop-blur-sm" id="charCount">0 KÝ TỰ</div>
                    
                    <div class="flex items-center gap-1 md:gap-2">
                         <button id="speakSource" class="action-btn p-2 md:p-2.5 rounded-xl text-gray-500 hover:bg-emerald-50 hover:text-emerald-600 tooltip-container" data-tooltip="Nghe">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="md:w-6 md:h-6"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/></svg>
                        </button>
                        <button id="clearBtn" class="action-btn p-2 md:p-2.5 rounded-xl text-gray-500 hover:bg-red-50 hover:text-red-500 tooltip-container" data-tooltip="Xóa">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="md:w-6 md:h-6"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Target Output Section -->
            <div class="flex flex-col flex-1 relative group glass-input bg-emerald-50/10 hover:bg-emerald-50/30 border-none transition-colors min-h-0">
                <div id="loadingOverlay" class="absolute inset-0 flex items-center justify-center bg-white/40 z-20 hidden backdrop-blur-sm transition-all duration-300">
                    <div class="bg-white/80 px-4 py-2 md:px-6 md:py-3 rounded-2xl shadow-xl flex items-center gap-3 border border-white/50">
                        <div class="spinner"></div>
                        <span id="loadingText" class="text-xs md:text-sm font-bold text-emerald-600 tracking-wide">Translating...</span>
                    </div>
                </div>

                <textarea id="translated" readonly 
                    placeholder="Bản dịch sẽ hiện ở đây..." 
                    class="w-full flex-1 p-4 md:p-8 text-base md:text-xl bg-transparent border-none text-emerald-900 font-medium resize-none placeholder-emerald-700/30 leading-relaxed focus:ring-0 overflow-auto"></textarea>
                
                <div class="px-3 py-2 md:px-6 md:py-4 flex items-center justify-end gap-2 md:gap-3 transition-all opacity-100 md:opacity-80 md:group-hover:opacity-100 border-t border-emerald-100/30 md:border-none shrink-0 bg-emerald-50/20 backdrop-blur-[2px]">
                    <button id="speakTarget" class="action-btn p-2 md:p-2.5 rounded-xl text-emerald-500 hover:bg-emerald-100/50 hover:text-emerald-700 tooltip-container" data-tooltip="Nghe">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="md:w-6 md:h-6"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/></svg>
                    </button>
                    
                    <div class="h-5 md:h-6 w-px bg-emerald-200/30"></div>

                    <button id="copyBtn" class="action-btn flex items-center gap-1.5 md:gap-2 px-3 py-1.5 md:px-5 md:py-2.5 bg-white/60 border border-emerald-100/50 shadow-sm rounded-xl text-xs md:text-sm font-bold text-emerald-600 hover:bg-emerald-500 hover:text-white hover:border-emerald-500 hover:shadow-lg hover:-translate-y-0.5 transition-all group/copy" title="Sao chép">
                        <svg id="copyIcon" xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="md:w-[18px] md:h-[18px]"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>
                        <span id="copyText">Sao chép</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- FULL SUPPORTED LANGUAGE LIST ---
        const languages = [
            { code: 'af', name: 'Afrikaans' }, { code: 'sq', name: 'Albanian' }, { code: 'am', name: 'Amharic' }, { code: 'ar', name: 'Arabic' },
            { code: 'hy', name: 'Armenian' }, { code: 'as', name: 'Assamese' }, { code: 'ay', name: 'Aymara' }, { code: 'az', name: 'Azerbaijani' },
            { code: 'bm', name: 'Bambara' }, { code: 'eu', name: 'Basque' }, { code: 'be', name: 'Belarusian' }, { code: 'bn', name: 'Bengali' },
            { code: 'bho', name: 'Bhojpuri' }, { code: 'bs', name: 'Bosnian' }, { code: 'bg', name: 'Bulgarian' }, { code: 'ca', name: 'Catalan' },
            { code: 'ceb', name: 'Cebuano' }, { code: 'ny', name: 'Chichewa' }, { code: 'zh-CN', name: 'Chinese (Simplified)' }, { code: 'zh-TW', name: 'Chinese (Traditional)' },
            { code: 'co', name: 'Corsican' }, { code: 'hr', name: 'Croatian' }, { code: 'cs', name: 'Czech' }, { code: 'da', name: 'Danish' },
            { code: 'dv', name: 'Dhivehi' }, { code: 'doi', name: 'Dogri' }, { code: 'nl', name: 'Dutch' }, { code: 'en', name: 'English' },
            { code: 'eo', name: 'Esperanto' }, { code: 'et', name: 'Estonian' }, { code: 'ee', name: 'Ewe' }, { code: 'tl', name: 'Filipino' },
            { code: 'fi', name: 'Finnish' }, { code: 'fr', name: 'French' }, { code: 'fy', name: 'Frisian' }, { code: 'gl', name: 'Galician' },
            { code: 'ka', name: 'Georgian' }, { code: 'de', name: 'German' }, { code: 'el', name: 'Greek' }, { code: 'gn', name: 'Guarani' },
            { code: 'gu', name: 'Gujarati' }, { code: 'ht', name: 'Haitian Creole' }, { code: 'ha', name: 'Hausa' }, { code: 'haw', name: 'Hawaiian' },
            { code: 'iw', name: 'Hebrew' }, { code: 'hi', name: 'Hindi' }, { code: 'hmn', name: 'Hmong' }, { code: 'hu', name: 'Hungarian' },
            { code: 'is', name: 'Icelandic' }, { code: 'ig', name: 'Igbo' }, { code: 'ilo', name: 'Ilocano' }, { code: 'id', name: 'Indonesian' },
            { code: 'ga', name: 'Irish' }, { code: 'it', name: 'Italian' }, { code: 'ja', name: 'Japanese' }, { code: 'jw', name: 'Javanese' },
            { code: 'kn', name: 'Kannada' }, { code: 'kk', name: 'Kazakh' }, { code: 'km', name: 'Khmer' }, { code: 'rw', name: 'Kinyarwanda' },
            { code: 'ko', name: 'Korean' }, { code: 'kri', name: 'Krio' }, { code: 'ku', name: 'Kurdish (Kurmanji)' }, { code: 'ckb', name: 'Kurdish (Sorani)' },
            { code: 'ky', name: 'Kyrgyz' }, { code: 'lo', name: 'Lao' }, { code: 'la', name: 'Latin' }, { code: 'lv', name: 'Latvian' },
            { code: 'ln', name: 'Lingala' }, { code: 'lt', name: 'Lithuanian' }, { code: 'lg', name: 'Luganda' }, { code: 'lb', name: 'Luxembourgish' },
            { code: 'mk', name: 'Macedonian' }, { code: 'mai', name: 'Maithili' }, { code: 'mg', name: 'Malagasy' }, { code: 'ms', name: 'Malay' },
            { code: 'ml', name: 'Malayalam' }, { code: 'mt', name: 'Maltese' }, { code: 'mi', name: 'Maori' }, { code: 'mr', name: 'Marathi' },
            { code: 'mni-Mtei', name: 'Meiteilon (Manipuri)' }, { code: 'lus', name: 'Mizo' }, { code: 'mn', name: 'Mongolian' }, { code: 'my', name: 'Myanmar (Burmese)' },
            { code: 'ne', name: 'Nepali' }, { code: 'no', name: 'Norwegian' }, { code: 'or', name: 'Odia (Oriya)' }, { code: 'om', name: 'Oromo' },
            { code: 'ps', name: 'Pashto' }, { code: 'fa', name: 'Persian' }, { code: 'pl', name: 'Polish' }, { code: 'pt', name: 'Portuguese' },
            { code: 'pa', name: 'Punjabi' }, { code: 'qu', name: 'Quechua' }, { code: 'ro', name: 'Romanian' }, { code: 'ru', name: 'Russian' },
            { code: 'sm', name: 'Samoan' }, { code: 'sa', name: 'Sanskrit' }, { code: 'gd', name: 'Scots Gaelic' }, { code: 'nso', name: 'Sepedi' },
            { code: 'sr', name: 'Serbian' }, { code: 'st', name: 'Sesotho' }, { code: 'sn', name: 'Shona' }, { code: 'sd', name: 'Sindhi' },
            { code: 'si', name: 'Sinhala' }, { code: 'sk', name: 'Slovak' }, { code: 'sl', name: 'Slovenian' }, { code: 'so', name: 'Somali' },
            { code: 'es', name: 'Spanish' }, { code: 'su', name: 'Sundanese' }, { code: 'sw', name: 'Swahili' }, { code: 'sv', name: 'Swedish' },
            { code: 'tg', name: 'Tajik' }, { code: 'ta', name: 'Tamil' }, { code: 'tt', name: 'Tatar' }, { code: 'te', name: 'Telugu' },
            { code: 'th', name: 'Thai' }, { code: 'ti', name: 'Tigrinya' }, { code: 'ts', name: 'Tsonga' }, { code: 'tr', name: 'Turkish' },
            { code: 'tk', name: 'Turkmen' }, { code: 'ak', name: 'Twi' }, { code: 'uk', name: 'Ukrainian' }, { code: 'ur', name: 'Urdu' },
            { code: 'ug', name: 'Uyghur' }, { code: 'uz', name: 'Uzbek' }, { code: 'vi', name: 'Vietnamese' }, { code: 'cy', name: 'Welsh' },
            { code: 'xh', name: 'Xhosa' }, { code: 'yi', name: 'Yiddish' }, { code: 'yo', name: 'Yoruba' }, { code: 'zu', name: 'Zulu' }
        ];
        
        // Sort languages A-Z
        languages.sort((a, b) => a.name.localeCompare(b.name));

        // Initial UI Strings
        const uiStrings = {
            vi: {
                placeholderSrc: "Nhập văn bản cần dịch...",
                placeholderTgt: "Bản dịch sẽ hiện ở đây...",
                swapTitle: "Đảo ngược ngôn ngữ",
                speakSrc: "Nghe (Nguồn)",
                speakTgt: "Nghe (Đích)",
                clearTitle: "Xóa văn bản",
                copy: "Sao chép",
                copied: "Đã chép!",
                chars: "KÝ TỰ",
                mobileBtn: "Dịch ngay",
                autoDetect: "Phát hiện ngôn ngữ",
                errorTrans: "Không thể dịch.",
                errorConn: "Lỗi kết nối mạng.",
                translating: "Đang dịch...",
                loadingUi: "Đang tải giao diện..."
            },
            en: {
                placeholderSrc: "Enter text to translate...",
                placeholderTgt: "Translation appears here...",
                swapTitle: "Swap languages",
                speakSrc: "Listen (Source)",
                speakTgt: "Listen (Target)",
                clearTitle: "Clear text",
                copy: "Copy",
                copied: "Copied!",
                chars: "CHARS",
                mobileBtn: "Translate Now",
                autoDetect: "Detect Language",
                errorTrans: "Translation failed.",
                errorConn: "Network error.",
                translating: "Translating...",
                loadingUi: "Loading UI..."
            },
            ja: {
                placeholderSrc: "翻訳するテキストを入力...",
                placeholderTgt: "翻訳結果...",
                swapTitle: "言語を切り替え",
                speakSrc: "聞く",
                speakTgt: "聞く",
                clearTitle: "クリア",
                copy: "コピー",
                copied: "完了",
                chars: "文字",
                mobileBtn: "翻訳する",
                autoDetect: "言語を検出",
                errorTrans: "翻訳エラー",
                errorConn: "通信エラー",
                translating: "翻訳中...",
                loadingUi: "読み込み中..."
            },
            'zh-CN': {
                placeholderSrc: "输入要翻译的文本...",
                placeholderTgt: "翻译结果...",
                swapTitle: "交换语言",
                speakSrc: "听",
                speakTgt: "听",
                clearTitle: "清除文本",
                copy: "复制",
                copied: "已复制！",
                chars: "字符",
                mobileBtn: "立即翻译",
                autoDetect: "检测语言",
                errorTrans: "翻译失败。",
                errorConn: "网络错误。",
                translating: "翻译中...",
                loadingUi: "加载中..."
            }
        };

        // --- DOM REFERENCES ---
        const sourceSelect = document.getElementById('sourceLang');
        const targetSelect = document.getElementById('targetLang');
        const src = document.getElementById('source');
        const out = document.getElementById('translated');
        const swapBtn = document.getElementById('swapBtn');
        const clearBtn = document.getElementById('clearBtn');
        const copyBtn = document.getElementById('copyBtn');
        const copyText = document.getElementById('copyText');
        const loading = document.getElementById('loadingOverlay');
        const uiLoadingOverlay = document.getElementById('uiLoadingOverlay');
        const charCount = document.getElementById('charCount');
        const speakSourceBtn = document.getElementById('speakSource');
        const speakTargetBtn = document.getElementById('speakTarget');
        const uiLangSelect = document.getElementById('uiLangSelect');
        const loadingText = document.getElementById('loadingText');

        // --- STATE ---
        let currentUiLang = 'vi';
        let debounceTimer = null;

        // Populate UI Language Select
        function initUiLangSelect() {
            uiLangSelect.innerHTML = '';
            
            const priorities = ['vi', 'en', 'ja', 'zh-CN', 'ko'];
            priorities.forEach(code => {
                const lang = languages.find(l => l.code === code);
                if(lang) {
                    const opt = document.createElement('option');
                    opt.value = lang.code;
                    opt.textContent = lang.name;
                    uiLangSelect.appendChild(opt);
                }
            });

            const hr = document.createElement('option');
            hr.disabled = true;
            hr.textContent = '──────────';
            uiLangSelect.appendChild(hr);

            languages.forEach(lang => {
                if(!priorities.includes(lang.code)) {
                    const opt = document.createElement('option');
                    opt.value = lang.code;
                    opt.textContent = lang.name;
                    uiLangSelect.appendChild(opt);
                }
            });
        }

        // --- UI UPDATES ---
        function applyUiStrings(strings) {
            src.placeholder = strings.placeholderSrc;
            out.placeholder = strings.placeholderTgt;
            
            swapBtn.setAttribute('data-tooltip', strings.swapTitle);
            speakSourceBtn.setAttribute('data-tooltip', strings.speakSrc);
            speakTargetBtn.setAttribute('data-tooltip', strings.speakTgt);
            clearBtn.setAttribute('data-tooltip', strings.clearTitle);
            copyBtn.title = strings.copy;

            if (!copyBtn.classList.contains('bg-green-500')) {
                copyText.textContent = strings.copy;
            }
            
            if(loadingText) loadingText.textContent = strings.translating;

            const count = src.value.length;
            charCount.textContent = `${count} ${strings.chars}`;

            const autoOption = sourceSelect.querySelector('option[value="auto"]');
            if (autoOption) autoOption.textContent = strings.autoDetect;
        }

        async function setInterfaceLanguage(langCode) {
            currentUiLang = langCode;
            
            // 1. Check Memory
            if (uiStrings[langCode]) {
                applyUiStrings(uiStrings[langCode]);
                populateSelect(sourceSelect, true);
                return;
            }

            // 2. Check LocalStorage
            const storageKey = `ui_strings_${langCode}`;
            const stored = localStorage.getItem(storageKey);
            if (stored) {
                try {
                    const parsed = JSON.parse(stored);
                    uiStrings[langCode] = parsed;
                    applyUiStrings(parsed);
                    populateSelect(sourceSelect, true);
                    return;
                } catch(e) {
                    localStorage.removeItem(storageKey);
                }
            }

            // 3. Fetch from API
            await fetchAndTranslateUi(langCode);
        }

        async function fetchAndTranslateUi(targetLang) {
            uiLoadingOverlay.classList.remove('hidden');
            
            const baseObj = uiStrings['en'];
            const keys = Object.keys(baseObj);
            const values = Object.values(baseObj);
            const separator = ' ||| ';
            const textToTranslate = values.join(separator);

            const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=en&tl=${targetLang}&dt=t&q=${encodeURIComponent(textToTranslate)}`;

            try {
                const res = await fetch(url);
                const data = await res.json();
                
                let fullTranslatedText = '';
                if(data && data[0]) {
                    fullTranslatedText = data[0].map(segment => segment[0]).join('');
                }

                let translatedValues = fullTranslatedText.split('|||').map(s => s.trim());
                
                if (translatedValues.length !== values.length) {
                    translatedValues = values; // Fallback
                }

                const newUiObj = {};
                keys.forEach((key, index) => {
                    let val = translatedValues[index] || values[index];
                    val = val.replace(/^\|/, '').trim();
                    newUiObj[key] = val;
                });

                uiStrings[targetLang] = newUiObj;
                localStorage.setItem(`ui_strings_${targetLang}`, JSON.stringify(newUiObj));
                applyUiStrings(newUiObj);
                populateSelect(sourceSelect, true);

            } catch (e) {
                applyUiStrings(uiStrings['en']);
            } finally {
                uiLoadingOverlay.classList.add('hidden');
            }
        }

        // --- CORE FUNCTIONS ---
        function populateSelect(selectElement, includeAuto = false) {
            const currentVal = selectElement.value;
            selectElement.innerHTML = ''; 

            if (includeAuto) {
                const autoOpt = document.createElement('option');
                autoOpt.value = 'auto';
                const currentStrings = uiStrings[currentUiLang] || uiStrings['en'];
                autoOpt.textContent = currentStrings.autoDetect;
                selectElement.appendChild(autoOpt);
                
                const hr = document.createElement('option');
                hr.disabled = true;
                hr.textContent = '──────────';
                selectElement.appendChild(hr);
            }

            languages.forEach(lang => {
                const opt = document.createElement('option');
                opt.value = lang.code;
                opt.textContent = lang.name;
                selectElement.appendChild(opt);
            });

            if(currentVal && Array.from(selectElement.options).some(o => o.value === currentVal)) {
                selectElement.value = currentVal;
            }
        }

        function translateText(text) {
            if (!text.trim()) {
                out.value = '';
                return;
            }

            loading.classList.remove('hidden');
            
            const sl = encodeURIComponent(sourceSelect.value);
            const tl = encodeURIComponent(targetSelect.value);
            const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=${sl}&tl=${tl}&dt=t&q=${encodeURIComponent(text)}`;

            const currentStrings = uiStrings[currentUiLang] || uiStrings['en'];

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (Array.isArray(data) && Array.isArray(data[0])) {
                        const translated = data[0].map(item => item[0]).join('');
                        out.value = translated;
                    } else {
                        out.value = currentStrings.errorTrans;
                    }
                })
                .catch(err => {
                    out.value = currentStrings.errorConn;
                })
                .finally(() => {
                    loading.classList.add('hidden');
                });
        }

        function handleInput() {
            const text = src.value;
            const currentStrings = uiStrings[currentUiLang] || uiStrings['en'];
            charCount.textContent = `${text.length} ${currentStrings.chars}`;
            
            clearTimeout(debounceTimer);
            if (!text.trim()) {
                out.value = '';
                return;
            }
            debounceTimer = setTimeout(() => {
                translateText(text);
            }, 800);
        }

        // --- EVENTS ---
        uiLangSelect.addEventListener('change', (e) => setInterfaceLanguage(e.target.value));
        src.addEventListener('input', handleInput);

        swapBtn.addEventListener('click', () => {
            const tempLang = sourceSelect.value;
            if (tempLang === 'auto') {
                 sourceSelect.value = targetSelect.value;
                 targetSelect.value = 'en'; 
            } else {
                sourceSelect.value = targetSelect.value;
                targetSelect.value = tempLang;
            }
            const tempText = src.value;
            src.value = out.value;
            out.value = tempText;
            handleInput();
        });

        sourceSelect.addEventListener('change', () => translateText(src.value));
        targetSelect.addEventListener('change', () => translateText(src.value));

        clearBtn.addEventListener('click', () => {
            src.value = '';
            out.value = '';
            const currentStrings = uiStrings[currentUiLang] || uiStrings['en'];
            charCount.textContent = `0 ${currentStrings.chars}`;
            src.focus();
        });

        copyBtn.addEventListener('click', () => {
            if (!out.value) return;
            const currentStrings = uiStrings[currentUiLang] || uiStrings['en'];

            // Universal Copy Support
            out.select();
            out.setSelectionRange(0, 99999);

            try {
                const successful = document.execCommand('copy');
                if (successful) animateCopySuccess(currentStrings);
                else throw new Error("execCommand failed");
            } catch (err) {
                 navigator.clipboard.writeText(out.value).then(() => {
                    animateCopySuccess(currentStrings);
                 });
            }
        });

        function animateCopySuccess(strings) {
            const icon = document.getElementById('copyIcon');
            const text = document.getElementById('copyText');
            const originalPath = '<rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/>';
            
            icon.innerHTML = '<polyline points="20 6 9 17 4 12"></polyline>'; 
            text.textContent = strings.copied;
            
            copyBtn.classList.remove('bg-white', 'border-emerald-100/50', 'text-emerald-600', 'bg-white/60');
            copyBtn.classList.add('bg-green-500', 'border-green-500', 'text-white', 'shadow-lg');

            setTimeout(() => {
                icon.innerHTML = originalPath;
                text.textContent = strings.copy;
                copyBtn.classList.add('bg-white/60', 'border-emerald-100/50', 'text-emerald-600');
                copyBtn.classList.remove('bg-green-500', 'border-green-500', 'text-white', 'shadow-lg');
            }, 2000);
        }

        function speak(text, lang) {
            if (!text) return;
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = lang === 'auto' ? 'vi' : lang; 
            window.speechSynthesis.speak(utterance);
        }

        speakSourceBtn.addEventListener('click', () => speak(src.value, sourceSelect.value));
        speakTargetBtn.addEventListener('click', () => speak(out.value, targetSelect.value));

        // --- INIT ---
        initUiLangSelect();
        
        const browserLang = navigator.language.split('-')[0];
        uiLangSelect.value = browserLang;
        if (!uiLangSelect.value) {
            uiLangSelect.value = 'vi';
            currentUiLang = 'vi';
        } else {
            currentUiLang = uiLangSelect.value;
        }

        populateSelect(sourceSelect, true);
        populateSelect(targetSelect, false);
        setInterfaceLanguage(currentUiLang); 

        const isSupported = languages.some(l => l.code === browserLang);
        const defaultTarget = isSupported ? browserLang : 'en';
        
        sourceSelect.value = 'auto';
        targetSelect.value = defaultTarget;
        src.focus();

    </script>
</body>
</html>